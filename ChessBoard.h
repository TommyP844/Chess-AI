#pragma once



#include <iostream>
#include <fstream>
#include <stack>
#include <vector>
#include "ChessDefines.h"
#include "Move.h"

#include "StopWatch.h"


class ChessBoard
{
public:
	ChessBoard();
	~ChessBoard();

    void init();


	void reset();

	
    Color getTurn() const { return mTurn; }

    Piece getPieceAtPosition(int index);

    // used to place a piece on a valid attack position
    bool placePiece(int index, Piece p);

    // used to place piece on tile no matter what
    void setPiece(int index, Piece p);

    void clearPiece(int index, Piece p);

    void setTurn(Color color) { mTurn = color; }

    u64 isKingInCheck(Color color);

    Move generateMove(int from, int to, Piece piece);

    Move getLastMove() { return (mPreviousMoves.empty() ? Move() : mPreviousMoves.back()); }

    int getNumMoves() { return mPreviousMoves.size(); }

    inline void applyMove(const Move& move);
    inline void undoMove(const Move& move);

	bool update(int index);

	Board getBoard() { return mBoard; }

private:
	friend class Algorithm;
	friend class ChessRenderer;

	Color mTurn;
	Board mBoard; // array of 64 Pieces
    bool mPromotionSelection;

    std::vector<Move> mPreviousMoves;

    void updateWhiteAndBlackBoards();

    int numBitsSet(u64 word);

    void print(u64 board);

    u64 getSuedoLegalMoves(int board_index, int piece_index, u64 blockerMask);
    void getSuedoLegalMoves(int board, int sq, Color color, u64 mask, std::vector<Move>& moves);
    u64 getLegalMoves(Color color, int board_index, int piece_index);

    bool positionUnderAttack(int index, Color color, u64 blockerMask);

    u64 get_rook_attacks(int index, u64 mask);
	u64 get_bishop_attacks(int index, u64 mask);
    u64 get_pawn_attacks(int index);

    void get_rook_moves(int moved, int index, Color color, u64 mask, std::vector<Move>& moves);
    void get_bishop_moves(int moved, int index, Color color, u64 mask, std::vector<Move>& moves);

    u64 set_bit(int square) { return 1ull << square; }

    int get_ls1b_index(u64 bitboard);


	// https://github.com/maksimKorzh/chess_programming/blob/master/src/magics/magics.c
    u64 rook_masks[64] = {
        282578800148862             ,
        565157600297596             ,
        1130315200595066            ,
        2260630401190006            ,
        4521260802379886            ,
        9042521604759646            ,
        18085043209519166           ,
        36170086419038334           ,
        282578800180736             ,
        565157600328704             ,
        1130315200625152            ,
        2260630401218048            ,
        4521260802403840            ,
        9042521604775424            ,
        18085043209518592           ,
        36170086419037696           ,
        282578808340736             ,
        565157608292864             ,
        1130315208328192            ,
        2260630408398848            ,
        4521260808540160            ,
        9042521608822784            ,
        18085043209388032           ,
        36170086418907136           ,
        282580897300736             ,
        565159647117824             ,
        1130317180306432            ,
        2260632246683648            ,
        4521262379438080            ,
        9042522644946944            ,
        18085043175964672           ,
        36170086385483776           ,
        283115671060736             ,
        565681586307584             ,
        1130822006735872            ,
        2261102847592448            ,
        4521664529305600            ,
        9042787892731904            ,
        18085034619584512           ,
        36170077829103616           ,
        420017753620736             ,
        699298018886144             ,
        1260057572672512            ,
        2381576680245248            ,
        4624614895390720            ,
        9110691325681664            ,
        18082844186263552           ,
        36167887395782656           ,
        35466950888980736           ,
        34905104758997504           ,
        34344362452452352           ,
        33222877839362048           ,
        30979908613181440           ,
        26493970160820224           ,
        17522093256097792           ,
        35607136465616896           ,
        9079539427579068672         ,
        8935706818303361536         ,
        8792156787827803136         ,
        8505056726876686336         ,
        7930856604974452736         ,
        6782456361169985536         ,
        4485655873561051136         ,
        9115426935197958144

    };
	u64 rook_magics[64] = {
        0xa8002c000108020ULL,
        0x6c00049b0002001ULL,
        0x100200010090040ULL,
        0x2480041000800801ULL,
        0x280028004000800ULL,
        0x900410008040022ULL,
        0x280020001001080ULL,
        0x2880002041000080ULL,
        0xa000800080400034ULL,
        0x4808020004000ULL,
        0x2290802004801000ULL,
        0x411000d00100020ULL,
        0x402800800040080ULL,
        0xb000401004208ULL,
        0x2409000100040200ULL,
        0x1002100004082ULL,
        0x22878001e24000ULL,
        0x1090810021004010ULL,
        0x801030040200012ULL,
        0x500808008001000ULL,
        0xa08018014000880ULL,
        0x8000808004000200ULL,
        0x201008080010200ULL,
        0x801020000441091ULL,
        0x800080204005ULL,
        0x1040200040100048ULL,
        0x120200402082ULL,
        0xd14880480100080ULL,
        0x12040280080080ULL,
        0x100040080020080ULL,
        0x9020010080800200ULL,
        0x813241200148449ULL,
        0x491604001800080ULL,
        0x100401000402001ULL,
        0x4820010021001040ULL,
        0x400402202000812ULL,
        0x209009005000802ULL,
        0x810800601800400ULL,
        0x4301083214000150ULL,
        0x204026458e001401ULL,
        0x40204000808000ULL,
        0x8001008040010020ULL,
        0x8410820820420010ULL,
        0x1003001000090020ULL,
        0x804040008008080ULL,
        0x12000810020004ULL,
        0x1000100200040208ULL,
        0x430000a044020001ULL,
        0x280009023410300ULL,
        0xe0100040002240ULL,
        0x200100401700ULL,
        0x2244100408008080ULL,
        0x8000400801980ULL,
        0x2000810040200ULL,
        0x8010100228810400ULL,
        0x2000009044210200ULL,
        0x4080008040102101ULL,
        0x40002080411d01ULL,
        0x2005524060000901ULL,
        0x502001008400422ULL,
        0x489a000810200402ULL,
        0x1004400080a13ULL,
        0x4000011008020084ULL,
        0x26002114058042ULL,
    };
	int rook_relevant_bits[64] = {
	12, 11, 11, 11, 11, 11, 11, 12,
	11, 10, 10, 10, 10, 10, 10, 11,
	11, 10, 10, 10, 10, 10, 10, 11,
	11, 10, 10, 10, 10, 10, 10, 11,
	11, 10, 10, 10, 10, 10, 10, 11,
	11, 10, 10, 10, 10, 10, 10, 11,
	11, 10, 10, 10, 10, 10, 10, 11,
	12, 11, 11, 11, 11, 11, 11, 12
	};
	u64 rook_attacks[64][4096];
    int rook_attack_positions[64][4096][14];
    int rook_num_attack_positions[64][4096];

    u64 bishop_masks[64] = {
        18049651735527936   ,
        70506452091904              ,
        275415828992                ,
        1075975168                  ,
        38021120                    ,
        8657588224                  ,
        2216338399232               ,
        567382630219776             ,
        9024825867763712            ,
        18049651735527424           ,
        70506452221952              ,
        275449643008                ,
        9733406720                  ,
        2216342585344               ,
        567382630203392             ,
        1134765260406784            ,
        4512412933816832            ,
        9024825867633664            ,
        18049651768822272           ,
        70515108615168              ,
        2491752130560               ,
        567383701868544             ,
        1134765256220672            ,
        2269530512441344            ,
        2256206450263040            ,
        4512412900526080            ,
        9024834391117824            ,
        18051867805491712           ,
        637888545440768             ,
        1135039602493440            ,
        2269529440784384            ,
        4539058881568768            ,
        1128098963916800            ,
        2256197927833600            ,
        4514594912477184            ,
        9592139778506752            ,
        19184279556981248           ,
        2339762086609920            ,
        4538784537380864            ,
        9077569074761728            ,
        562958610993152             ,
        1125917221986304            ,
        2814792987328512            ,
        5629586008178688            ,
        11259172008099840           ,
        22518341868716544           ,
        9007336962655232            ,
        18014673925310464           ,
        2216338399232               ,
        4432676798464               ,
        11064376819712              ,
        22137335185408              ,
        44272556441600              ,
        87995357200384              ,
        35253226045952              ,
        70506452091904              ,
        567382630219776             ,
        1134765260406784            ,
        2832480465846272            ,
        5667157807464448            ,
        11333774449049600           ,
        22526811443298304           ,
        9024825867763712            ,
        18049651735527936           
    };
	u64 bishop_magics[64] = {
    0x89a1121896040240ULL,
    0x2004844802002010ULL,
    0x2068080051921000ULL,
    0x62880a0220200808ULL,
    0x4042004000000ULL,
    0x100822020200011ULL,
    0xc00444222012000aULL,
    0x28808801216001ULL,
    0x400492088408100ULL,
    0x201c401040c0084ULL,
    0x840800910a0010ULL,
    0x82080240060ULL,
    0x2000840504006000ULL,
    0x30010c4108405004ULL,
    0x1008005410080802ULL,
    0x8144042209100900ULL,
    0x208081020014400ULL,
    0x4800201208ca00ULL,
    0xf18140408012008ULL,
    0x1004002802102001ULL,
    0x841000820080811ULL,
    0x40200200a42008ULL,
    0x800054042000ULL,
    0x88010400410c9000ULL,
    0x520040470104290ULL,
    0x1004040051500081ULL,
    0x2002081833080021ULL,
    0x400c00c010142ULL,
    0x941408200c002000ULL,
    0x658810000806011ULL,
    0x188071040440a00ULL,
    0x4800404002011c00ULL,
    0x104442040404200ULL,
    0x511080202091021ULL,
    0x4022401120400ULL,
    0x80c0040400080120ULL,
    0x8040010040820802ULL,
    0x480810700020090ULL,
    0x102008e00040242ULL,
    0x809005202050100ULL,
    0x8002024220104080ULL,
    0x431008804142000ULL,
    0x19001802081400ULL,
    0x200014208040080ULL,
    0x3308082008200100ULL,
    0x41010500040c020ULL,
    0x4012020c04210308ULL,
    0x208220a202004080ULL,
    0x111040120082000ULL,
    0x6803040141280a00ULL,
    0x2101004202410000ULL,
    0x8200000041108022ULL,
    0x21082088000ULL,
    0x2410204010040ULL,
    0x40100400809000ULL,
    0x822088220820214ULL,
    0x40808090012004ULL,
    0x910224040218c9ULL,
    0x402814422015008ULL,
    0x90014004842410ULL,
    0x1000042304105ULL,
    0x10008830412a00ULL,
    0x2520081090008908ULL,
    0x40102000a0a60140ULL,
    };
	int bishop_relevant_bits[64] = {
		6, 5, 5, 5, 5, 5, 5, 6,
		5, 5, 5, 5, 5, 5, 5, 5,
		5, 5, 7, 7, 7, 7, 5, 5,
		5, 5, 7, 9, 9, 7, 5, 5,
		5, 5, 7, 9, 9, 7, 5, 5,
		5, 5, 7, 7, 7, 7, 5, 5,
		5, 5, 5, 5, 5, 5, 5, 5,
		6, 5, 5, 5, 5, 5, 5, 6
	};
	u64 bishop_attacks[64][512];
    int bishop_attack_positions[64][512][14];
    int bishop_num_attack_positions[64][512];

    u64 knight_attacks[64] = {
        132096            ,
        329728                  ,
        659712                  ,
        1319424                 ,
        2638848                 ,
        5277696                 ,
        10489856                ,
        4202496                 ,
        33816580                ,
        84410376                ,
        168886289               ,
        337772578               ,
        675545156               ,
        1351090312              ,
        2685403152              ,
        1075839008              ,
        8657044482              ,
        21609056261             ,
        43234889994             ,
        86469779988             ,
        172939559976            ,
        345879119952            ,
        687463207072            ,
        275414786112            ,
        2216203387392           ,
        5531918402816           ,
        11068131838464          ,
        22136263676928          ,
        44272527353856          ,
        88545054707712          ,
        175990581010432         ,
        70506185244672          ,
        567348067172352         ,
        1416171111120896        ,
        2833441750646784        ,
        5666883501293568        ,
        11333767002587136       ,
        22667534005174272       ,
        45053588738670592       ,
        18049583422636032       ,
        145241105196122112      ,
        362539804446949376      ,
        725361088165576704      ,
        1450722176331153408     ,
        2901444352662306816     ,
        5802888705324613632     ,
        11533718717099671552    ,
        4620693356194824192     ,
        288234782788157440      ,
        576469569871282176      ,
        1224997833292120064     ,
        2449995666584240128     ,
        4899991333168480256     ,
        9799982666336960512     ,
        1152939783987658752     ,
        2305878468463689728     ,
        1128098930098176        ,
        2257297371824128        ,
        4796069720358912        ,
        9592139440717824        ,
        19184278881435648       ,
        38368557762871296       ,
        4679521487814656        ,
        9077567998918656        ,
    };
    int knight_attack_positions[64][256][8];
    int knight_num_attacks[64][256];

    u64 king_attacks[64] = {
        770                 ,
        1797                        ,
        3594                        ,
        7188                        ,
        14376                       ,
        28752                       ,
        57504                       ,
        49216                       ,
        197123                      ,
        460039                      ,
        920078                      ,
        1840156                     ,
        3680312                     ,
        7360624                     ,
        14721248                    ,
        12599488                    ,
        50463488                    ,
        117769984                   ,
        235539968                   ,
        471079936                   ,
        942159872                   ,
        1884319744                  ,
        3768639488                  ,
        3225468928                  ,
        12918652928                 ,
        30149115904                 ,
        60298231808                 ,
        120596463616                ,
        241192927232                ,
        482385854464                ,
        964771708928                ,
        825720045568                ,
        3307175149568               ,
        7718173671424               ,
        15436347342848              ,
        30872694685696              ,
        61745389371392              ,
        123490778742784             ,
        246981557485568             ,
        211384331665408             ,
        846636838289408             ,
        1975852459884544            ,
        3951704919769088            ,
        7903409839538176            ,
        15806819679076352           ,
        31613639358152704           ,
        63227278716305408           ,
        54114388906344448           ,
        216739030602088448          ,
        505818229730443264          ,
        1011636459460886528         ,
        2023272918921773056         ,
        4046545837843546112         ,
        8093091675687092224         ,
        16186183351374184448        ,
        13853283560024178688        ,
        144959613005987840          ,
        362258295026614272          ,
        724516590053228544          ,
        1449033180106457088         ,
        2898066360212914176         ,
        5796132720425828352         ,
        11592265440851656704        ,
        4665729213955833856         
    };

    u64 pawn_attacks[2][64];
    u64 pawn_moves[2][64];
};

